name: Deployment Workflow

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main
        types: [opened, synchronize]

env:
    SKIP_DEPLOY: ${{ contains(join(github.event.commits.*.message, ' '), '#skip') }}

jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Install root dependencies
              run: npm install

            - name: Install frontend dependencies
              working-directory: client
              run: npm install

            - name: Lint code (lints both backend and frontend)
              run: npm run lint

            - name: Build the application (builds both backend and frontend)
              run: npm run build

            - name: Set up Fly Deployment
              if: ${{ github.event_name == 'push' && env.SKIP_DEPLOY != 'true' }}
              uses: superfly/flyctl-actions/setup-flyctl@master

            - name: Deploy to Fly.io
              if: ${{ github.event_name == 'push' && env.SKIP_DEPLOY != 'true' }}
              run: flyctl deploy --remote-only
              env:
                  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

    tag_release:
        needs: [build-and-deploy]
        runs-on: ubuntu-latest
        if: ${{ github.event_name == 'push' && !contains(join(github.event.commits.*.message, ' '), '#skip') }}
        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Bump version and push tag
              uses: anothrNick/github-tag-action@e528bc2b9628971ce0e6f823f3052d1dcd9d512c
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  DEFAULT_BUMP: "patch"
